<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”€å²©è£…å¤‡å•†åŸ - æ•°æ®åº“é…ç½®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f3f4f6;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #1f2937;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
        }
        
        .section.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        
        .section.success {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        
        .section.info {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        h2 {
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
        }
        
        .icon.error { background-color: #ef4444; }
        .icon.success { background-color: #10b981; }
        .icon.info { background-color: #3b82f6; }
        
        pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
            margin: 15px 0;
        }
        
        .button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 10px 10px 0;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .button:hover {
            background-color: #2563eb;
        }
        
        .button.success {
            background-color: #10b981;
        }
        
        .button.success:hover {
            background-color: #059669;
        }
        
        ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        
        .code {
            background-color: #f3f4f6;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§—â€â™‚ï¸ æ”€å²©è£…å¤‡å•†åŸ</h1>
        <p class="subtitle">æ•°æ®åº“ç»“æ„ä¿®å¤ä¸é…ç½®æŒ‡å—</p>
        
        <!-- é—®é¢˜è¯´æ˜ -->
        <div class="section error">
            <h2>
                <span class="icon error">âŒ</span>
                æ£€æµ‹åˆ°çš„é—®é¢˜
            </h2>
            <p><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong></p>
            <div class="code">column "user_id" of relation "profiles" does not exist</div>
            <p style="margin-top: 10px;">è¿™è¯´æ˜æ•°æ®åº“ä¸­çš„profilesè¡¨ç»“æ„ä¸å®Œæ•´ï¼Œç¼ºå°‘å¿…è¦çš„å­—æ®µã€‚</p>
        </div>
        
        <!-- è§£å†³æ–¹æ¡ˆ -->
        <div class="section info">
            <h2>
                <span class="icon info">ğŸ”§</span>
                è§£å†³æ–¹æ¡ˆ
            </h2>
            <p>è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œæ•°æ®åº“ä¿®å¤è„šæœ¬ï¼š</p>
            <ol>
                <li>å¤åˆ¶ä¸‹é¢çš„SQLè„šæœ¬</li>
                <li>è®¿é—® <a href="https://supabase.com/dashboard" target="_blank">Supabaseæ§åˆ¶å°</a></li>
                <li>é€‰æ‹©æ‚¨çš„é¡¹ç›®</li>
                <li>ç‚¹å‡»å·¦ä¾§ "SQL Editor"</li>
                <li>ç²˜è´´è„šæœ¬å¹¶ç‚¹å‡» "Run" æ‰§è¡Œ</li>
                <li>ç¡®è®¤çœ‹åˆ° "Database structure fixed successfully!" æ¶ˆæ¯</li>
            </ol>
            
            <button class="button" onclick="copyScript()">ğŸ“‹ å¤åˆ¶SQLè„šæœ¬</button>
        </div>
        
        <!-- SQLè„šæœ¬ -->
        <div class="section">
            <h2>
                <span class="icon info">ğŸ“œ</span>
                æ•°æ®åº“ä¿®å¤è„šæœ¬
            </h2>
            <pre id="sqlScript">-- æ”€å²©è£…å¤‡å•†åŸæ•°æ®åº“ç»“æ„ä¿®å¤è„šæœ¬
-- è¯·åœ¨Supabase SQLç¼–è¾‘å™¨ä¸­æ‰§è¡Œä»¥ä¸‹è„šæœ¬

-- 1. åˆ›å»ºæˆ–ä¿®å¤profilesè¡¨
CREATE TABLE IF NOT EXISTS profiles (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT,
  full_name TEXT,
  role TEXT DEFAULT 'user',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 2. æ·»åŠ ç¼ºå°‘çš„åˆ—ï¼ˆå¦‚æœè¡¨å·²å­˜åœ¨ï¼‰
DO $$ 
BEGIN
  -- æ·»åŠ user_idåˆ—ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'profiles' AND column_name = 'user_id'
  ) THEN
    ALTER TABLE profiles ADD COLUMN user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE;
  END IF;

  -- æ·»åŠ å…¶ä»–å¿…è¦åˆ—
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'profiles' AND column_name = 'email'
  ) THEN
    ALTER TABLE profiles ADD COLUMN email TEXT;
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'profiles' AND column_name = 'full_name'
  ) THEN
    ALTER TABLE profiles ADD COLUMN full_name TEXT;
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'profiles' AND column_name = 'role'
  ) THEN
    ALTER TABLE profiles ADD COLUMN role TEXT DEFAULT 'user';
  END IF;
END $$;

-- 3. åˆ›å»ºæ”€å²©è£…å¤‡åˆ†ç±»è¡¨
CREATE TABLE IF NOT EXISTS categories (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 3.1 ä¸ºç°æœ‰çš„categoriesè¡¨æ·»åŠ slugå­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
DO $$ 
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'categories' AND column_name = 'slug'
  ) THEN
    ALTER TABLE categories ADD COLUMN slug TEXT;
    -- ä¸ºç°æœ‰è®°å½•ç”Ÿæˆslug
    UPDATE categories SET slug = 
      CASE 
        WHEN name = 'æ”€å²©ç»³ç´¢' THEN 'climbing-ropes'
        WHEN name = 'ä¿æŠ¤è£…å¤‡' THEN 'protection-gear'
        WHEN name = 'æ”€ç™»ç¡¬ä»¶' THEN 'climbing-hardware'
        WHEN name = 'æ”€å²©é‹' THEN 'climbing-shoes'
        WHEN name = 'è®­ç»ƒè£…å¤‡' THEN 'training-gear'
        ELSE lower(replace(replace(name, ' ', '-'), '/', '-'))
      END
    WHERE slug IS NULL;
    -- è®¾ç½®ä¸ºå¿…å¡«ä¸”å”¯ä¸€
    ALTER TABLE categories ALTER COLUMN slug SET NOT NULL;
    ALTER TABLE categories ADD CONSTRAINT categories_slug_unique UNIQUE (slug);
  END IF;
END $$;

-- 4. åˆ›å»ºæ”€å²©è£…å¤‡äº§å“è¡¨
CREATE TABLE IF NOT EXISTS products (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  price DECIMAL(10,2),
  category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
  stock_quantity INTEGER DEFAULT 0,
  image_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 5. åˆ›å»ºè®¢å•è¡¨
CREATE TABLE IF NOT EXISTS orders (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  total_amount DECIMAL(10,2),
  status TEXT DEFAULT 'pending',
  customer_name TEXT,
  customer_email TEXT,
  customer_phone TEXT,
  shipping_address TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 6. åˆ›å»ºè®¢å•é¡¹ç›®è¡¨
CREATE TABLE IF NOT EXISTS order_items (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id) ON DELETE CASCADE,
  quantity INTEGER NOT NULL,
  price DECIMAL(10,2) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 7. è®¾ç½®è¡Œçº§å®‰å…¨ç­–ç•¥ï¼ˆç®€åŒ–ç‰ˆæœ¬é¿å…é€’å½’ï¼‰
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE order_items ENABLE ROW LEVEL SECURITY;

-- åˆ é™¤å¯èƒ½å­˜åœ¨çš„é—®é¢˜ç­–ç•¥
DROP POLICY IF EXISTS "Users can view own profile" ON profiles CASCADE;
DROP POLICY IF EXISTS "Users can update own profile" ON profiles CASCADE;
DROP POLICY IF EXISTS "Enable read access for authenticated users" ON profiles CASCADE;
DROP POLICY IF EXISTS "Allow all authenticated users" ON profiles CASCADE;

-- åˆ›å»ºç®€å•çš„RLSç­–ç•¥
CREATE POLICY "simple_profiles_access" ON profiles FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "simple_categories_access" ON categories FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "simple_products_access" ON products FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "simple_orders_access" ON orders FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "simple_order_items_access" ON order_items FOR ALL TO authenticated USING (true) WITH CHECK (true);

-- 8. æ¸…ç†é‡å¤çš„åˆ†ç±»è®°å½•
DELETE FROM categories WHERE name IN ('æ”€å²©ç»³ç´¢', 'ä¿æŠ¤è£…å¤‡', 'æ”€ç™»ç¡¬ä»¶', 'æ”€å²©é‹', 'è®­ç»ƒè£…å¤‡') AND slug IS NULL;

-- 8.1 æ’å…¥æ”€å²©è£…å¤‡åŸºç¡€åˆ†ç±»ï¼ˆåŒ…å«slugå­—æ®µï¼‰
INSERT INTO categories (name, slug, description) VALUES
  ('æ”€å²©ç»³ç´¢', 'climbing-ropes', 'åŠ¨åŠ›ç»³ã€é™åŠ›ç»³ã€è¾…ç»³ç­‰å„ç§æ”€å²©ç»³ç´¢'),
  ('ä¿æŠ¤è£…å¤‡', 'protection-gear', 'å®‰å…¨å¸¦ã€å¤´ç›”ã€ä¿æŠ¤å™¨ç­‰å®‰å…¨ä¿æŠ¤è£…å¤‡'),
  ('æ”€ç™»ç¡¬ä»¶', 'climbing-hardware', 'å²©é’‰ã€å¿«æŒ‚ã€å²©å¡ã€é“é”ç­‰æ”€ç™»ç¡¬ä»¶'),
  ('æ”€å²©é‹', 'climbing-shoes', 'å„ç§ç±»å‹çš„ä¸“ä¸šæ”€å²©é‹'),
  ('è®­ç»ƒè£…å¤‡', 'training-gear', 'æŒ‡åŠ›æ¿ã€è®­ç»ƒå™¨æç­‰å®¤å†…è®­ç»ƒè£…å¤‡')
ON CONFLICT (slug) DO NOTHING;

-- 9. åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ language 'plpgsql';

-- åº”ç”¨è§¦å‘å™¨
DROP TRIGGER IF EXISTS update_profiles_updated_at ON profiles;
CREATE TRIGGER update_profiles_updated_at BEFORE UPDATE ON profiles FOR EACH ROW EXECUTE PROCEDURE update_updated_at_column();

DROP TRIGGER IF EXISTS update_products_updated_at ON products;
CREATE TRIGGER update_products_updated_at BEFORE UPDATE ON products FOR EACH ROW EXECUTE PROCEDURE update_updated_at_column();

DROP TRIGGER IF EXISTS update_orders_updated_at ON orders;
CREATE TRIGGER update_orders_updated_at BEFORE UPDATE ON orders FOR EACH ROW EXECUTE PROCEDURE update_updated_at_column();

-- å®Œæˆæç¤º
SELECT 'ğŸ‰ æ”€å²©è£…å¤‡å•†åŸæ•°æ®åº“ç»“æ„ä¿®å¤å®Œæˆï¼' as result;</pre>
        </div>
        
        <!-- æ‰§è¡Œå®Œæˆå -->
        <div class="section success">
            <h2>
                <span class="icon success">âœ…</span>
                æ‰§è¡Œå®Œæˆå
            </h2>
            <p>æ•°æ®åº“ä¿®å¤å®Œæˆåï¼Œæ‚¨çš„æ”€å²©è£…å¤‡å•†åŸå°†æ‹¥æœ‰ï¼š</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>âœ… å®Œæ•´çš„ç”¨æˆ·æ¡£æ¡ˆç³»ç»Ÿ</li>
                <li>âœ… æ”€å²©è£…å¤‡åˆ†ç±»ç®¡ç†</li>
                <li>âœ… äº§å“åº“å­˜ç®¡ç†</li>
                <li>âœ… è®¢å•å¤„ç†ç³»ç»Ÿ</li>
                <li>âœ… ç®€åŒ–çš„æƒé™ç­–ç•¥ï¼ˆé¿å…é€’å½’é—®é¢˜ï¼‰</li>
            </ul>
            
            <div style="margin-top: 20px;">
                <a href="/manual-admin" class="button success">ğŸ‘¥ åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·</a>
                <a href="/auth/login" class="button">ğŸ”‘ ç™»å½•ç³»ç»Ÿ</a>
                <a href="/" class="button">ğŸª æŸ¥çœ‹å•†åŸ</a>
            </div>
        </div>
        
        <div class="warning">
            <strong>âš ï¸ æ³¨æ„ï¼š</strong>æ‰§è¡Œè„šæœ¬åï¼Œå»ºè®®é‡å¯æ‚¨çš„åº”ç”¨ç¨‹åºä»¥ç¡®ä¿æ‰€æœ‰æ›´æ”¹ç”Ÿæ•ˆã€‚
        </div>
    </div>

    <script>
        function copyScript() {
            const script = document.getElementById('sqlScript').textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(script).then(function() {
                    alert('âœ… SQLè„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }, function() {
                    alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
                });
            } else {
                // å¤‡ç”¨æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = script;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('âœ… SQLè„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                } catch (err) {
                    alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
                }
                document.body.removeChild(textArea);
            }
        }
    </script>
</body>
</html> 