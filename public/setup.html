<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>攀岩装备商城 - 数据库配置</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f3f4f6;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #1f2937;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
        }
        
        .section.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        
        .section.success {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        
        .section.info {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        h2 {
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
        }
        
        .icon.error { background-color: #ef4444; }
        .icon.success { background-color: #10b981; }
        .icon.info { background-color: #3b82f6; }
        
        pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
            margin: 15px 0;
        }
        
        .button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 10px 10px 0;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .button:hover {
            background-color: #2563eb;
        }
        
        .button.success {
            background-color: #10b981;
        }
        
        .button.success:hover {
            background-color: #059669;
        }
        
        ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        
        .code {
            background-color: #f3f4f6;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧗‍♂️ 攀岩装备商城</h1>
        <p class="subtitle">数据库结构修复与配置指南</p>
        
        <!-- 问题说明 -->
        <div class="section error">
            <h2>
                <span class="icon error">❌</span>
                检测到的问题
            </h2>
            <p><strong>错误信息：</strong></p>
            <div class="code">column "user_id" of relation "profiles" does not exist</div>
            <p style="margin-top: 10px;">这说明数据库中的profiles表结构不完整，缺少必要的字段。</p>
        </div>
        
        <!-- 解决方案 -->
        <div class="section info">
            <h2>
                <span class="icon info">🔧</span>
                解决方案
            </h2>
            <p>请按以下步骤执行数据库修复脚本：</p>
            <ol>
                <li>复制下面的SQL脚本</li>
                <li>访问 <a href="https://supabase.com/dashboard" target="_blank">Supabase控制台</a></li>
                <li>选择您的项目</li>
                <li>点击左侧 "SQL Editor"</li>
                <li>粘贴脚本并点击 "Run" 执行</li>
                <li>确认看到 "Database structure fixed successfully!" 消息</li>
            </ol>
            
            <button class="button" onclick="copyScript()">📋 复制SQL脚本</button>
        </div>
        
        <!-- SQL脚本 -->
        <div class="section">
            <h2>
                <span class="icon info">📜</span>
                数据库修复脚本
            </h2>
            <pre id="sqlScript">-- 攀岩装备商城数据库结构修复脚本
-- 请在Supabase SQL编辑器中执行以下脚本

-- 1. 创建或修复profiles表
CREATE TABLE IF NOT EXISTS profiles (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT,
  full_name TEXT,
  role TEXT DEFAULT 'user',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 2. 添加缺少的列（如果表已存在）
DO $$ 
BEGIN
  -- 添加user_id列（如果不存在）
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'profiles' AND column_name = 'user_id'
  ) THEN
    ALTER TABLE profiles ADD COLUMN user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE;
  END IF;

  -- 添加其他必要列
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'profiles' AND column_name = 'email'
  ) THEN
    ALTER TABLE profiles ADD COLUMN email TEXT;
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'profiles' AND column_name = 'full_name'
  ) THEN
    ALTER TABLE profiles ADD COLUMN full_name TEXT;
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'profiles' AND column_name = 'role'
  ) THEN
    ALTER TABLE profiles ADD COLUMN role TEXT DEFAULT 'user';
  END IF;
END $$;

-- 3. 创建攀岩装备分类表
CREATE TABLE IF NOT EXISTS categories (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 3.1 为现有的categories表添加slug字段（如果不存在）
DO $$ 
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'categories' AND column_name = 'slug'
  ) THEN
    ALTER TABLE categories ADD COLUMN slug TEXT;
    -- 为现有记录生成slug
    UPDATE categories SET slug = 
      CASE 
        WHEN name = '攀岩绳索' THEN 'climbing-ropes'
        WHEN name = '保护装备' THEN 'protection-gear'
        WHEN name = '攀登硬件' THEN 'climbing-hardware'
        WHEN name = '攀岩鞋' THEN 'climbing-shoes'
        WHEN name = '训练装备' THEN 'training-gear'
        ELSE lower(replace(replace(name, ' ', '-'), '/', '-'))
      END
    WHERE slug IS NULL;
    -- 设置为必填且唯一
    ALTER TABLE categories ALTER COLUMN slug SET NOT NULL;
    ALTER TABLE categories ADD CONSTRAINT categories_slug_unique UNIQUE (slug);
  END IF;
END $$;

-- 4. 创建攀岩装备产品表
CREATE TABLE IF NOT EXISTS products (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  price DECIMAL(10,2),
  category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
  stock_quantity INTEGER DEFAULT 0,
  image_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 5. 创建订单表
CREATE TABLE IF NOT EXISTS orders (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  total_amount DECIMAL(10,2),
  status TEXT DEFAULT 'pending',
  customer_name TEXT,
  customer_email TEXT,
  customer_phone TEXT,
  shipping_address TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 6. 创建订单项目表
CREATE TABLE IF NOT EXISTS order_items (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id) ON DELETE CASCADE,
  quantity INTEGER NOT NULL,
  price DECIMAL(10,2) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 7. 设置行级安全策略（简化版本避免递归）
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE order_items ENABLE ROW LEVEL SECURITY;

-- 删除可能存在的问题策略
DROP POLICY IF EXISTS "Users can view own profile" ON profiles CASCADE;
DROP POLICY IF EXISTS "Users can update own profile" ON profiles CASCADE;
DROP POLICY IF EXISTS "Enable read access for authenticated users" ON profiles CASCADE;
DROP POLICY IF EXISTS "Allow all authenticated users" ON profiles CASCADE;

-- 创建简单的RLS策略
CREATE POLICY "simple_profiles_access" ON profiles FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "simple_categories_access" ON categories FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "simple_products_access" ON products FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "simple_orders_access" ON orders FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "simple_order_items_access" ON order_items FOR ALL TO authenticated USING (true) WITH CHECK (true);

-- 8. 清理重复的分类记录
DELETE FROM categories WHERE name IN ('攀岩绳索', '保护装备', '攀登硬件', '攀岩鞋', '训练装备') AND slug IS NULL;

-- 8.1 插入攀岩装备基础分类（包含slug字段）
INSERT INTO categories (name, slug, description) VALUES
  ('攀岩绳索', 'climbing-ropes', '动力绳、静力绳、辅绳等各种攀岩绳索'),
  ('保护装备', 'protection-gear', '安全带、头盔、保护器等安全保护装备'),
  ('攀登硬件', 'climbing-hardware', '岩钉、快挂、岩塞、铁锁等攀登硬件'),
  ('攀岩鞋', 'climbing-shoes', '各种类型的专业攀岩鞋'),
  ('训练装备', 'training-gear', '指力板、训练器材等室内训练装备')
ON CONFLICT (slug) DO NOTHING;

-- 9. 创建更新时间触发器
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ language 'plpgsql';

-- 应用触发器
DROP TRIGGER IF EXISTS update_profiles_updated_at ON profiles;
CREATE TRIGGER update_profiles_updated_at BEFORE UPDATE ON profiles FOR EACH ROW EXECUTE PROCEDURE update_updated_at_column();

DROP TRIGGER IF EXISTS update_products_updated_at ON products;
CREATE TRIGGER update_products_updated_at BEFORE UPDATE ON products FOR EACH ROW EXECUTE PROCEDURE update_updated_at_column();

DROP TRIGGER IF EXISTS update_orders_updated_at ON orders;
CREATE TRIGGER update_orders_updated_at BEFORE UPDATE ON orders FOR EACH ROW EXECUTE PROCEDURE update_updated_at_column();

-- 完成提示
SELECT '🎉 攀岩装备商城数据库结构修复完成！' as result;</pre>
        </div>
        
        <!-- 执行完成后 -->
        <div class="section success">
            <h2>
                <span class="icon success">✅</span>
                执行完成后
            </h2>
            <p>数据库修复完成后，您的攀岩装备商城将拥有：</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>✅ 完整的用户档案系统</li>
                <li>✅ 攀岩装备分类管理</li>
                <li>✅ 产品库存管理</li>
                <li>✅ 订单处理系统</li>
                <li>✅ 简化的权限策略（避免递归问题）</li>
            </ul>
            
            <div style="margin-top: 20px;">
                <a href="/manual-admin" class="button success">👥 创建管理员账户</a>
                <a href="/auth/login" class="button">🔑 登录系统</a>
                <a href="/" class="button">🏪 查看商城</a>
            </div>
        </div>
        
        <div class="warning">
            <strong>⚠️ 注意：</strong>执行脚本后，建议重启您的应用程序以确保所有更改生效。
        </div>
    </div>

    <script>
        function copyScript() {
            const script = document.getElementById('sqlScript').textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(script).then(function() {
                    alert('✅ SQL脚本已复制到剪贴板！');
                }, function() {
                    alert('❌ 复制失败，请手动选择复制');
                });
            } else {
                // 备用方案
                const textArea = document.createElement('textarea');
                textArea.value = script;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('✅ SQL脚本已复制到剪贴板！');
                } catch (err) {
                    alert('❌ 复制失败，请手动选择复制');
                }
                document.body.removeChild(textArea);
            }
        }
    </script>
</body>
</html> 