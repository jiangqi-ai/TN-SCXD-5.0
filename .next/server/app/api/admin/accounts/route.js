(()=>{var e={};e.id=599,e.ids=[599],e.modules={2213:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=2213,e.exports=t},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{"use strict";e.exports=require("buffer")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},1808:e=>{"use strict";e.exports=require("net")},5477:e=>{"use strict";e.exports=require("punycode")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},7310:e=>{"use strict";e.exports=require("url")},9796:e=>{"use strict";e.exports=require("zlib")},8359:()=>{},3739:()=>{},603:(e,t,r)=>{"use strict";r.r(t),r.d(t,{headerHooks:()=>m,originalPathname:()=>_,patchFetch:()=>v,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>b,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>y});var i={};r.r(i),r.d(i,{GET:()=>d,POST:()=>p});var a=r(884),n=r(6132),o=r(1040),s=r(7847);class c{static{this.instance={config:null,client:null,initialized:!1}}static getDefaultConfig(){let e="https://demo-project.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.demo";return e&&t?{url:e,anonKey:t,serviceRoleKey:process.env.SUPABASE_SERVICE_ROLE_KEY,connectionPool:10,timeout:30}:null}static async loadConfigFromDatabase(){try{let e=this.getDefaultConfig();if(!e)return console.warn("No default config available, cannot load from database"),null;let t=(0,s.eI)(e.url,e.anonKey),{data:r,error:i}=await t.from("settings").select("key, value").in("key",["db_url","db_anon_key","db_service_key","db_connection_pool","db_timeout"]);if(i)return console.warn("Failed to load config from database:",i),e;if(!r||0===r.length)return console.log("No database config found, using default"),e;let a={};r.forEach(e=>{switch(e.key){case"db_url":a.url=e.value;break;case"db_anon_key":a.anonKey=e.value;break;case"db_service_key":a.serviceRoleKey=e.value;break;case"db_connection_pool":a.connectionPool=parseInt(e.value)||10;break;case"db_timeout":a.timeout=parseInt(e.value)||30}});let n={url:a.url||e.url,anonKey:a.anonKey||e.anonKey,serviceRoleKey:a.serviceRoleKey||e.serviceRoleKey,connectionPool:a.connectionPool||10,timeout:a.timeout||30};return console.log("Loaded config from database successfully"),n}catch(e){return console.error("Error loading config from database:",e),this.getDefaultConfig()}}static async initialize(){if(this.instance.initialized&&this.instance.client)return this.instance.client;try{let e=await this.loadConfigFromDatabase();if(e||(e=this.getDefaultConfig()),!e)return console.error("No valid Supabase configuration found"),null;let t=(0,s.eI)(e.url,e.anonKey,{auth:{persistSession:!0,autoRefreshToken:!0},db:{schema:"public"}});return this.instance.config=e,this.instance.client=t,this.instance.initialized=!0,console.log("Supabase client initialized successfully"),t}catch(e){return console.error("Failed to initialize Supabase client:",e),null}}static getClient(){return this.instance.client}static getConfig(){return this.instance.config}static async reloadConfig(){return this.instance.initialized=!1,this.instance.client=null,this.instance.config=null,await this.initialize()}static async updateConfig(e){try{let t=this.getClient();if(!t)throw Error("No client available for config update");let r=[];for(let i of(e.url&&r.push({key:"db_url",value:e.url,category:"database",is_public:!1}),e.anonKey&&r.push({key:"db_anon_key",value:e.anonKey,category:"database",is_public:!1}),e.serviceRoleKey&&r.push({key:"db_service_key",value:e.serviceRoleKey,category:"database",is_public:!1}),void 0!==e.connectionPool&&r.push({key:"db_connection_pool",value:e.connectionPool.toString(),category:"database",is_public:!1}),void 0!==e.timeout&&r.push({key:"db_timeout",value:e.timeout.toString(),category:"database",is_public:!1}),r)){let{error:e}=await t.from("settings").upsert(i,{onConflict:"key"});if(e)throw e}return await this.reloadConfig(),console.log("Database config updated successfully"),!0}catch(e){return console.error("Failed to update database config:",e),!1}}static async checkConnection(){try{let e=this.getClient();if(!e)return{connected:!1,error:"No client available"};let{data:t,error:r}=await e.from("settings").select("count").limit(1);if(r)return{connected:!1,error:r.message};return{connected:!0}}catch(e){return{connected:!1,error:e.message}}}}function l(){let e=c.getClient();if(e)return e;let t="https://demo-project.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.demo";t&&r||console.warn("Missing Supabase environment variables, using placeholder values for build");let i=(0,s.eI)(t||"https://placeholder.supabase.co",r||"placeholder-key",{auth:{persistSession:!0,autoRefreshToken:!0},db:{schema:"public"}});return i}l();var u=r(5798);async function d(){try{let e=l(),{data:t,error:r}=await e.from("profiles").select("id, email, full_name, role, created_at, last_sign_in_at").eq("role","admin").order("created_at",{ascending:!1});if(r)throw r;return u.Z.json({admins:t})}catch(e){return console.error("获取管理员账户失败:",e),u.Z.json({error:"获取管理员账户失败",details:e.message},{status:500})}}async function p(e){try{let{email:t,password:r,fullName:i}=await e.json();if(!t||!r||!i)return u.Z.json({error:"邮箱、密码和姓名都是必填项"},{status:400});let a=l(),{data:n,error:o}=await a.auth.admin.createUser({email:t,password:r,email_confirm:!0});if(o)throw o;if(n.user){let{error:e}=await a.from("profiles").insert([{id:n.user.id,email:t,full_name:i,role:"admin"}]);if(e)throw await a.auth.admin.deleteUser(n.user.id),e;return u.Z.json({message:"管理员账户创建成功",user:{id:n.user.id,email:t,full_name:i,role:"admin"}})}return u.Z.json({error:"创建用户失败"},{status:500})}catch(e){return console.error("创建管理员账户失败:",e),u.Z.json({error:"创建管理员账户失败",details:e.message},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/accounts/route",pathname:"/api/admin/accounts",filename:"route",bundlePath:"app/api/admin/accounts/route"},resolvedPagePath:"E:\\starter-template\\TN-SCXD-5.0\\app\\api\\admin\\accounts\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:h,staticGenerationAsyncStorage:g,serverHooks:b,headerHooks:m,staticGenerationBailout:y}=f,_="/api/admin/accounts/route";function v(){return(0,o.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:g})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[271,741],()=>r(603));module.exports=i})();