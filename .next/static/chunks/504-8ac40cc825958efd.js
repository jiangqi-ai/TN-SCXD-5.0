"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[504],{3504:function(e,t,n){n.d(t,{Z:function(){return v}});var a=n(7437),i=n(610),r=n(4033),s=n(2265),l=n(1396),o=n.n(l),c=n(5119),u=n(4322),d=n(3505),f=n(5750),m=n(7332),h=n(3071),g=n(9409),y=n(9036),x=n(4689),b=n(2549),p=n(8004);function v(e){let{children:t}=e,{user:n,profile:l,loading:v}=(0,i.useAuth)(),_=(0,r.useRouter)(),N=(0,r.usePathname)(),[k,w]=(0,s.useState)(!1);(0,s.useEffect)(()=>{v||n&&(null==l?void 0:l.role)==="admin"||_.push("/")},[n,l,v,_]);let j=[{name:"仪表板",href:"/admin",icon:c.Z,current:"/admin"===N},{name:"产品管理",href:"/admin/products",icon:u.Z,current:"/admin/products"===N},{name:"订单管理",href:"/admin/orders",icon:d.Z,current:"/admin/orders"===N},{name:"用户管理",href:"/admin/users",icon:f.Z,current:"/admin/users"===N},{name:"数据库管理",href:"/admin/database",icon:m.Z,current:"/admin/database"===N},{name:"数据库配置",href:"/admin/database-config",icon:h.Z,current:"/admin/database-config"===N},{name:"系统设置",href:"/admin/settings",icon:g.Z,current:"/admin/settings"===N},{name:"系统初始化",href:"/admin/setup",icon:y.Z,current:"/admin/setup"===N},{name:"数据统计",href:"/admin/analytics",icon:x.Z,current:"/admin/analytics"===N}];return v?(0,a.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-primary-600"})}):n&&(null==l?void 0:l.role)==="admin"?(0,a.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,a.jsxs)("div",{className:"fixed inset-0 z-40 lg:hidden ".concat(k?"block":"hidden"),children:[(0,a.jsx)("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-75",onClick:()=>w(!1)}),(0,a.jsxs)("div",{className:"relative flex-1 flex flex-col max-w-xs w-full bg-white",children:[(0,a.jsx)("div",{className:"absolute top-0 right-0 -mr-12 pt-2",children:(0,a.jsx)("button",{type:"button",className:"ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white",onClick:()=>w(!1),children:(0,a.jsx)(b.Z,{className:"h-6 w-6 text-white"})})}),(0,a.jsxs)("div",{className:"flex-1 h-0 pt-5 pb-4 overflow-y-auto",children:[(0,a.jsx)("div",{className:"flex-shrink-0 flex items-center px-4",children:(0,a.jsx)("h1",{className:"text-xl font-bold text-gray-900",children:"管理后台"})}),(0,a.jsx)("nav",{className:"mt-5 px-2 space-y-1",children:j.map(e=>(0,a.jsxs)(o(),{href:e.href,className:"group flex items-center px-2 py-2 text-base font-medium rounded-md ".concat(e.current?"bg-primary-100 text-primary-900":"text-gray-600 hover:bg-gray-50 hover:text-gray-900"),onClick:()=>w(!1),children:[(0,a.jsx)(e.icon,{className:"mr-4 flex-shrink-0 h-6 w-6 ".concat(e.current?"text-primary-500":"text-gray-400 group-hover:text-gray-500")}),e.name]},e.name))})]})]})]}),(0,a.jsx)("div",{className:"hidden lg:flex lg:w-64 lg:flex-col lg:fixed lg:inset-y-0",children:(0,a.jsx)("div",{className:"flex-1 flex flex-col min-h-0 bg-white border-r border-gray-200",children:(0,a.jsxs)("div",{className:"flex-1 flex flex-col pt-5 pb-4 overflow-y-auto",children:[(0,a.jsx)("div",{className:"flex items-center flex-shrink-0 px-4",children:(0,a.jsx)("h1",{className:"text-xl font-bold text-gray-900",children:"管理后台"})}),(0,a.jsx)("nav",{className:"mt-5 flex-1 px-2 space-y-1",children:j.map(e=>(0,a.jsxs)(o(),{href:e.href,className:"group flex items-center px-2 py-2 text-sm font-medium rounded-md ".concat(e.current?"bg-primary-100 text-primary-900":"text-gray-600 hover:bg-gray-50 hover:text-gray-900"),children:[(0,a.jsx)(e.icon,{className:"mr-3 flex-shrink-0 h-6 w-6 ".concat(e.current?"text-primary-500":"text-gray-400 group-hover:text-gray-500")}),e.name]},e.name))})]})})}),(0,a.jsxs)("div",{className:"lg:pl-64 flex flex-col flex-1",children:[(0,a.jsx)("div",{className:"sticky top-0 z-10 lg:hidden pl-1 pt-1 sm:pl-3 sm:pt-3 bg-gray-100",children:(0,a.jsx)("button",{type:"button",className:"-ml-0.5 -mt-0.5 h-12 w-12 inline-flex items-center justify-center rounded-md text-gray-500 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500",onClick:()=>w(!0),children:(0,a.jsx)(p.Z,{className:"h-6 w-6"})})}),(0,a.jsx)("main",{className:"flex-1",children:(0,a.jsx)("div",{className:"py-6",children:t})})]})]}):null}},610:function(e,t,n){n.r(t),n.d(t,{default:function(){return o},useAuth:function(){return l}});var a=n(7437),i=n(2265),r=n(2899);let s=(0,i.createContext)(void 0);function l(){let e=(0,i.useContext)(s);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function o(e){let{children:t}=e,[n,l]=(0,i.useState)(null),[o,c]=(0,i.useState)(null),[u,d]=(0,i.useState)(!0),f=(0,r.JU)(),m=async()=>{if(!n)return;let{data:e}=await f.from("profiles").select("*").eq("id",n.id).single();c(e)},h=async()=>{await f.auth.signOut(),l(null),c(null)};return(0,i.useEffect)(()=>{let e=async()=>{let{data:{user:e}}=await f.auth.getUser();l(e),e&&await m(),d(!1)};e();let{data:{subscription:t}}=f.auth.onAuthStateChange(async(e,t)=>{var n;l(null!==(n=null==t?void 0:t.user)&&void 0!==n?n:null),(null==t?void 0:t.user)?await m():c(null),d(!1)});return()=>t.unsubscribe()},[null==n?void 0:n.id]),(0,a.jsx)(s.Provider,{value:{user:n,profile:o,loading:u,signOut:h,refreshProfile:m},children:t})}},7521:function(e,t,n){var a=n(2362),i=n(2601);class r{static getDefaultConfig(){let e="https://demo-project.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.demo";return e&&t?{url:e,anonKey:t,serviceRoleKey:i.env.SUPABASE_SERVICE_ROLE_KEY,connectionPool:10,timeout:30}:null}static async loadConfigFromDatabase(){try{let e=this.getDefaultConfig();if(!e)return console.warn("No default config available, cannot load from database"),null;let t=(0,a.eI)(e.url,e.anonKey),{data:n,error:i}=await t.from("settings").select("key, value").in("key",["db_url","db_anon_key","db_service_key","db_connection_pool","db_timeout"]);if(i)return console.warn("Failed to load config from database:",i),e;if(!n||0===n.length)return console.log("No database config found, using default"),e;let r={};n.forEach(e=>{switch(e.key){case"db_url":r.url=e.value;break;case"db_anon_key":r.anonKey=e.value;break;case"db_service_key":r.serviceRoleKey=e.value;break;case"db_connection_pool":r.connectionPool=parseInt(e.value)||10;break;case"db_timeout":r.timeout=parseInt(e.value)||30}});let s={url:r.url||e.url,anonKey:r.anonKey||e.anonKey,serviceRoleKey:r.serviceRoleKey||e.serviceRoleKey,connectionPool:r.connectionPool||10,timeout:r.timeout||30};return console.log("Loaded config from database successfully"),s}catch(e){return console.error("Error loading config from database:",e),this.getDefaultConfig()}}static async initialize(){if(this.instance.initialized&&this.instance.client)return this.instance.client;try{let e=await this.loadConfigFromDatabase();if(e||(e=this.getDefaultConfig()),!e)return console.error("No valid Supabase configuration found"),null;let t=(0,a.eI)(e.url,e.anonKey,{auth:{persistSession:!0,autoRefreshToken:!0},db:{schema:"public"}});return this.instance.config=e,this.instance.client=t,this.instance.initialized=!0,console.log("Supabase client initialized successfully"),t}catch(e){return console.error("Failed to initialize Supabase client:",e),null}}static getClient(){return this.instance.client}static getConfig(){return this.instance.config}static async reloadConfig(){return this.instance.initialized=!1,this.instance.client=null,this.instance.config=null,await this.initialize()}static async updateConfig(e){try{let t=this.getClient();if(!t)throw Error("No client available for config update");let n=[];for(let a of(e.url&&n.push({key:"db_url",value:e.url,category:"database",is_public:!1}),e.anonKey&&n.push({key:"db_anon_key",value:e.anonKey,category:"database",is_public:!1}),e.serviceRoleKey&&n.push({key:"db_service_key",value:e.serviceRoleKey,category:"database",is_public:!1}),void 0!==e.connectionPool&&n.push({key:"db_connection_pool",value:e.connectionPool.toString(),category:"database",is_public:!1}),void 0!==e.timeout&&n.push({key:"db_timeout",value:e.timeout.toString(),category:"database",is_public:!1}),n)){let{error:e}=await t.from("settings").upsert(a,{onConflict:"key"});if(e)throw e}return await this.reloadConfig(),console.log("Database config updated successfully"),!0}catch(e){return console.error("Failed to update database config:",e),!1}}static async checkConnection(){try{let e=this.getClient();if(!e)return{connected:!1,error:"No client available"};let{data:t,error:n}=await e.from("settings").select("count").limit(1);if(n)return{connected:!1,error:n.message};return{connected:!0}}catch(e){return{connected:!1,error:e.message}}}}r.instance={config:null,client:null,initialized:!1},t.Z=r},2899:function(e,t,n){n.d(t,{JU:function(){return r}});var a=n(2362),i=n(7521);function r(){let e=i.Z.getClient();if(e)return e;let t="https://demo-project.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.demo";t&&n||(console.warn("Missing Supabase environment variables, using placeholder values for build"),t||console.error("Missing NEXT_PUBLIC_SUPABASE_URL environment variable"),n||console.error("Missing NEXT_PUBLIC_SUPABASE_ANON_KEY environment variable"));let r=(0,a.eI)(t||"https://placeholder.supabase.co",n||"placeholder-key",{auth:{persistSession:!0,autoRefreshToken:!0},db:{schema:"public"}});return r}r()}}]);