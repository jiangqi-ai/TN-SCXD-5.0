(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[285],{6142:function(e,t,a){"use strict";a.d(t,{Z:function(){return i}});var s=a(2898);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let i=(0,s.Z)("MapPin",[["path",{d:"M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z",key:"2oe9fu"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]])},2741:function(e,t,a){"use strict";a.d(t,{Z:function(){return i}});var s=a(2898);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let i=(0,s.Z)("Phone",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]])},8695:function(e,t,a){Promise.resolve().then(a.bind(a,2174))},2174:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return x},dynamic:function(){return p}});var s=a(7437),i=a(2265),n=a(7267),r=a(610),l=a(2899),o=a(1865),c=a(4033),u=a(5925),d=a(6142),m=a(2741),h=a(2898);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let f=(0,h.Z)("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]);var y=a(9270);let p="force-dynamic";function x(){let{items:e,getTotalPrice:t,clearCart:a}=(0,n.j)(),{user:h}=(0,r.useAuth)(),[p,x]=(0,i.useState)(!1),[g,b]=(0,i.useState)(!1),v=(0,c.useRouter)(),N=(0,l.JU)(),{register:j,handleSubmit:_,formState:{errors:k}}=(0,o.cI)();(0,i.useEffect)(()=>{b(!0)},[]),(0,i.useEffect)(()=>{g&&!h&&v.push("/auth/login")},[g,h,v]),(0,i.useEffect)(()=>{g&&0===e.length&&v.push("/cart")},[g,e.length,v]);let w=e=>new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY"}).format(e),C=async s=>{if(!h){u.default.error("请先登录");return}if(0===e.length){u.default.error("购物车为空");return}x(!0);try{let{data:i,error:n}=await N.from("orders").insert({user_id:h.id,total_amount:t(),shipping_address:s.shippingAddress,contact_phone:s.contactPhone,notes:s.notes||null,status:"pending"}).select().single();if(n)throw n;let r=e.map(e=>({order_id:i.id,product_id:e.id,quantity:e.quantity,price:e.price})),{error:l}=await N.from("order_items").insert(r);if(l)throw l;for(let t of e){let{error:e}=await N.from("products").update({stock_quantity:t.stock_quantity-t.quantity}).eq("id",t.id);e&&console.error("Stock update error:",e)}a(),u.default.success("订单创建成功！"),v.push("/orders/".concat(i.id))}catch(e){console.error("Checkout error:",e),u.default.error("订单创建失败，请重试")}finally{x(!1)}};return g&&h&&0!==e.length?(0,s.jsxs)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-8",children:"确认订单"}),(0,s.jsxs)("div",{className:"grid lg:grid-cols-3 gap-8",children:[(0,s.jsx)("div",{className:"lg:col-span-2",children:(0,s.jsxs)("div",{className:"card",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-6",children:"配送信息"}),(0,s.jsxs)("form",{onSubmit:_(C),className:"space-y-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"shippingAddress",className:"block text-sm font-medium text-gray-700 mb-2",children:"配送地址 *"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(d.Z,{className:"absolute left-3 top-3 h-5 w-5 text-gray-400"}),(0,s.jsx)("textarea",{...j("shippingAddress",{required:"请输入配送地址",minLength:{value:10,message:"地址至少10个字符"}}),rows:3,className:"input-field pl-10",placeholder:"请输入详细的配送地址，包括省市区和具体地址"})]}),k.shippingAddress&&(0,s.jsx)("p",{className:"mt-1 text-sm text-red-600",children:k.shippingAddress.message})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"contactPhone",className:"block text-sm font-medium text-gray-700 mb-2",children:"联系电话 *"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(m.Z,{className:"absolute left-3 top-3 h-5 w-5 text-gray-400"}),(0,s.jsx)("input",{...j("contactPhone",{required:"请输入联系电话",pattern:{value:/^1[3-9]\d{9}$/,message:"请输入有效的手机号码"}}),type:"tel",className:"input-field pl-10",placeholder:"请输入您的手机号码"})]}),k.contactPhone&&(0,s.jsx)("p",{className:"mt-1 text-sm text-red-600",children:k.contactPhone.message})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"notes",className:"block text-sm font-medium text-gray-700 mb-2",children:"备注信息"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(f,{className:"absolute left-3 top-3 h-5 w-5 text-gray-400"}),(0,s.jsx)("textarea",{...j("notes"),rows:3,className:"input-field pl-10",placeholder:"有什么特殊要求可以在这里备注（选填）"})]})]}),(0,s.jsx)("button",{type:"submit",disabled:p,className:"w-full btn-primary py-3 text-lg disabled:opacity-50",children:p?"处理中...":"确认下单"})]})]})}),(0,s.jsx)("div",{className:"lg:col-span-1",children:(0,s.jsxs)("div",{className:"card sticky top-8",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-6",children:"订单摘要"}),(0,s.jsx)("div",{className:"space-y-4 mb-6",children:e.map(e=>(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("div",{className:"w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0",children:e.image_url?(0,s.jsx)("img",{src:e.image_url,alt:e.name,className:"w-full h-full object-cover rounded-lg"}):(0,s.jsx)(y.Z,{className:"h-6 w-6 text-gray-400"})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-900 truncate",children:e.name}),(0,s.jsxs)("p",{className:"text-sm text-gray-500",children:["数量: ",e.quantity]})]}),(0,s.jsx)("p",{className:"text-sm font-medium text-gray-900",children:w(e.price*e.quantity)})]},e.id))}),(0,s.jsxs)("div",{className:"border-t border-gray-200 pt-4",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,s.jsx)("span",{className:"text-sm text-gray-600",children:"商品小计"}),(0,s.jsx)("span",{className:"text-sm text-gray-900",children:w(t())})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,s.jsx)("span",{className:"text-sm text-gray-600",children:"运费"}),(0,s.jsx)("span",{className:"text-sm text-green-600",children:"免费"})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center pt-2 border-t border-gray-200",children:[(0,s.jsx)("span",{className:"text-lg font-semibold text-gray-900",children:"总计"}),(0,s.jsx)("span",{className:"text-xl font-bold text-primary-600",children:w(t())})]})]})]})})]})]}):(0,s.jsx)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:(0,s.jsx)("div",{className:"flex justify-center items-center h-64",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"})})})}},610:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return o},useAuth:function(){return l}});var s=a(7437),i=a(2265),n=a(2899);let r=(0,i.createContext)(void 0);function l(){let e=(0,i.useContext)(r);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function o(e){let{children:t}=e,[a,l]=(0,i.useState)(null),[o,c]=(0,i.useState)(null),[u,d]=(0,i.useState)(!0),m=(0,n.JU)(),h=async()=>{if(!a)return;let{data:e}=await m.from("profiles").select("*").eq("id",a.id).single();c(e)},f=async()=>{await m.auth.signOut(),l(null),c(null)};return(0,i.useEffect)(()=>{let e=async()=>{let{data:{user:e}}=await m.auth.getUser();l(e),e&&await h(),d(!1)};e();let{data:{subscription:t}}=m.auth.onAuthStateChange(async(e,t)=>{var a;l(null!==(a=null==t?void 0:t.user)&&void 0!==a?a:null),(null==t?void 0:t.user)?await h():c(null),d(!1)});return()=>t.unsubscribe()},[null==a?void 0:a.id]),(0,s.jsx)(r.Provider,{value:{user:a,profile:o,loading:u,signOut:f,refreshProfile:h},children:t})}},7521:function(e,t,a){"use strict";var s=a(2362),i=a(2601);class n{static getDefaultConfig(){let e="https://demo-project.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.demo";return e&&t?{url:e,anonKey:t,serviceRoleKey:i.env.SUPABASE_SERVICE_ROLE_KEY,connectionPool:10,timeout:30}:null}static async loadConfigFromDatabase(){try{let e=this.getDefaultConfig();if(!e)return console.warn("No default config available, cannot load from database"),null;let t=(0,s.eI)(e.url,e.anonKey),{data:a,error:i}=await t.from("settings").select("key, value").in("key",["db_url","db_anon_key","db_service_key","db_connection_pool","db_timeout"]);if(i)return console.warn("Failed to load config from database:",i),e;if(!a||0===a.length)return console.log("No database config found, using default"),e;let n={};a.forEach(e=>{switch(e.key){case"db_url":n.url=e.value;break;case"db_anon_key":n.anonKey=e.value;break;case"db_service_key":n.serviceRoleKey=e.value;break;case"db_connection_pool":n.connectionPool=parseInt(e.value)||10;break;case"db_timeout":n.timeout=parseInt(e.value)||30}});let r={url:n.url||e.url,anonKey:n.anonKey||e.anonKey,serviceRoleKey:n.serviceRoleKey||e.serviceRoleKey,connectionPool:n.connectionPool||10,timeout:n.timeout||30};return console.log("Loaded config from database successfully"),r}catch(e){return console.error("Error loading config from database:",e),this.getDefaultConfig()}}static async initialize(){if(this.instance.initialized&&this.instance.client)return this.instance.client;try{let e=await this.loadConfigFromDatabase();if(e||(e=this.getDefaultConfig()),!e)return console.error("No valid Supabase configuration found"),null;let t=(0,s.eI)(e.url,e.anonKey,{auth:{persistSession:!0,autoRefreshToken:!0},db:{schema:"public"}});return this.instance.config=e,this.instance.client=t,this.instance.initialized=!0,console.log("Supabase client initialized successfully"),t}catch(e){return console.error("Failed to initialize Supabase client:",e),null}}static getClient(){return this.instance.client}static getConfig(){return this.instance.config}static async reloadConfig(){return this.instance.initialized=!1,this.instance.client=null,this.instance.config=null,await this.initialize()}static async updateConfig(e){try{let t=this.getClient();if(!t)throw Error("No client available for config update");let a=[];for(let s of(e.url&&a.push({key:"db_url",value:e.url,category:"database",is_public:!1}),e.anonKey&&a.push({key:"db_anon_key",value:e.anonKey,category:"database",is_public:!1}),e.serviceRoleKey&&a.push({key:"db_service_key",value:e.serviceRoleKey,category:"database",is_public:!1}),void 0!==e.connectionPool&&a.push({key:"db_connection_pool",value:e.connectionPool.toString(),category:"database",is_public:!1}),void 0!==e.timeout&&a.push({key:"db_timeout",value:e.timeout.toString(),category:"database",is_public:!1}),a)){let{error:e}=await t.from("settings").upsert(s,{onConflict:"key"});if(e)throw e}return await this.reloadConfig(),console.log("Database config updated successfully"),!0}catch(e){return console.error("Failed to update database config:",e),!1}}static async checkConnection(){try{let e=this.getClient();if(!e)return{connected:!1,error:"No client available"};let{data:t,error:a}=await e.from("settings").select("count").limit(1);if(a)return{connected:!1,error:a.message};return{connected:!0}}catch(e){return{connected:!1,error:e.message}}}}n.instance={config:null,client:null,initialized:!1},t.Z=n},2899:function(e,t,a){"use strict";a.d(t,{JU:function(){return n}});var s=a(2362),i=a(7521);function n(){let e=i.Z.getClient();if(e)return e;let t="https://demo-project.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.demo";if(!t)throw console.error("Missing NEXT_PUBLIC_SUPABASE_URL environment variable"),Error("Supabase URL is required");if(!a)throw console.error("Missing NEXT_PUBLIC_SUPABASE_ANON_KEY environment variable"),Error("Supabase Anonymous Key is required");let n=(0,s.eI)(t,a,{auth:{persistSession:!0,autoRefreshToken:!0},db:{schema:"public"}});return n}n()},7267:function(e,t,a){"use strict";a.d(t,{j:function(){return n}});var s=a(4660),i=a(4810);let n=(0,s.Ue)()((0,i.tJ)((e,t)=>({items:[],addItem:a=>{let s=t().items,i=s.find(e=>e.id===a.id);i?e({items:s.map(e=>e.id===a.id?{...e,quantity:Math.min(e.quantity+1,a.stock_quantity)}:e)}):e({items:[...s,{...a,quantity:1}]})},removeItem:a=>{e({items:t().items.filter(e=>e.id!==a)})},updateQuantity:(a,s)=>{if(s<=0){t().removeItem(a);return}e({items:t().items.map(e=>e.id===a?{...e,quantity:Math.min(s,e.stock_quantity)}:e)})},clearCart:()=>{e({items:[]})},getTotalPrice:()=>t().items.reduce((e,t)=>e+t.price*t.quantity,0),getTotalItems:()=>t().items.reduce((e,t)=>e+t.quantity,0)}),{name:"cart-storage"}))}},function(e){e.O(0,[199,535,367,971,472,744],function(){return e(e.s=8695)}),_N_E=e.O()}]);