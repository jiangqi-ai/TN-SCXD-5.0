(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[565],{9883:function(e,t,n){"use strict";n.d(t,{Z:function(){return i}});var a=n(2898);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let i=(0,a.Z)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},5367:function(e,t,n){"use strict";n.d(t,{Z:function(){return i}});var a=n(2898);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let i=(0,a.Z)("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]])},5804:function(e,t,n){Promise.resolve().then(n.bind(n,984))},984:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return y}});var a=n(7437),i=n(7267),s=n(610),l=n(2898);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let r=(0,l.Z)("ShoppingBag",[["path",{d:"M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z",key:"hou9p0"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M16 10a4 4 0 0 1-8 0",key:"1ltviw"}]]);var o=n(5367),c=n(9270);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let u=(0,l.Z)("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);var d=n(9883),h=n(1396),m=n.n(h),f=n(4033);function y(){let{items:e,updateQuantity:t,removeItem:n,getTotalPrice:l,clearCart:h}=(0,i.j)(),{user:y}=(0,s.useAuth)(),x=(0,f.useRouter)(),g=e=>new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY"}).format(e);return 0===e.length?(0,a.jsx)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)(r,{className:"h-16 w-16 text-gray-300 mx-auto mb-4"}),(0,a.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"购物车为空"}),(0,a.jsx)("p",{className:"text-gray-600 mb-8",children:"快去挑选心仪的攀岩装备吧！"}),(0,a.jsx)(m(),{href:"/products",className:"btn-primary inline-block",children:"开始购物"})]})}):(0,a.jsxs)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[(0,a.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-8",children:"购物车"}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:[(0,a.jsx)("div",{className:"px-6 py-4 border-b border-gray-200",children:(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("h2",{className:"text-lg font-semibold text-gray-900",children:["商品 (",e.length," 件)"]}),(0,a.jsxs)("button",{onClick:h,className:"text-red-600 hover:text-red-700 text-sm flex items-center gap-1",children:[(0,a.jsx)(o.Z,{className:"h-4 w-4"}),"清空购物车"]})]})}),(0,a.jsx)("div",{className:"divide-y divide-gray-200",children:e.map(e=>(0,a.jsx)("div",{className:"px-6 py-6",children:(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("div",{className:"flex-shrink-0 w-20 h-20 bg-gray-200 rounded-lg flex items-center justify-center",children:e.image_url?(0,a.jsx)("img",{src:e.image_url,alt:e.name,className:"w-full h-full object-cover rounded-lg"}):(0,a.jsx)(c.Z,{className:"h-8 w-8 text-gray-400"})}),(0,a.jsxs)("div",{className:"ml-6 flex-1",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:e.name}),(0,a.jsx)("p",{className:"text-gray-600",children:g(e.price)}),(0,a.jsxs)("p",{className:"text-sm text-gray-500",children:["库存: ",e.stock_quantity," 件"]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:()=>t(e.id,e.quantity-1),className:"p-1 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors",children:(0,a.jsx)(u,{className:"h-4 w-4"})}),(0,a.jsx)("span",{className:"w-12 text-center font-medium",children:e.quantity}),(0,a.jsx)("button",{onClick:()=>t(e.id,e.quantity+1),disabled:e.quantity>=e.stock_quantity,className:"p-1 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:(0,a.jsx)(d.Z,{className:"h-4 w-4"})})]}),(0,a.jsx)("div",{className:"text-right min-w-[120px]",children:(0,a.jsx)("p",{className:"text-lg font-semibold text-gray-900",children:g(e.price*e.quantity)})}),(0,a.jsx)("button",{onClick:()=>n(e.id),className:"p-2 text-red-600 hover:text-red-700 transition-colors",children:(0,a.jsx)(o.Z,{className:"h-5 w-5"})})]})]})},e.id))}),(0,a.jsxs)("div",{className:"px-6 py-6 border-t border-gray-200 bg-gray-50",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,a.jsx)("span",{className:"text-lg font-semibold text-gray-900",children:"总计:"}),(0,a.jsx)("span",{className:"text-2xl font-bold text-primary-600",children:g(l())})]}),(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row gap-4",children:[(0,a.jsx)(m(),{href:"/products",className:"btn-secondary flex-1 text-center",children:"继续购物"}),(0,a.jsx)("button",{onClick:()=>{if(!y){x.push("/auth/login");return}x.push("/checkout")},className:"btn-primary flex-1",children:y?"立即结算":"登录并结算"})]})]})]})]})}},610:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return o},useAuth:function(){return r}});var a=n(7437),i=n(2265),s=n(2899);let l=(0,i.createContext)(void 0);function r(){let e=(0,i.useContext)(l);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function o(e){let{children:t}=e,[n,r]=(0,i.useState)(null),[o,c]=(0,i.useState)(null),[u,d]=(0,i.useState)(!0),h=(0,s.JU)(),m=async()=>{if(!n)return;let{data:e}=await h.from("profiles").select("*").eq("id",n.id).single();c(e)},f=async()=>{await h.auth.signOut(),r(null),c(null)};return(0,i.useEffect)(()=>{let e=async()=>{let{data:{user:e}}=await h.auth.getUser();r(e),e&&await m(),d(!1)};e();let{data:{subscription:t}}=h.auth.onAuthStateChange(async(e,t)=>{var n;r(null!==(n=null==t?void 0:t.user)&&void 0!==n?n:null),(null==t?void 0:t.user)?await m():c(null),d(!1)});return()=>t.unsubscribe()},[null==n?void 0:n.id]),(0,a.jsx)(l.Provider,{value:{user:n,profile:o,loading:u,signOut:f,refreshProfile:m},children:t})}},7521:function(e,t,n){"use strict";var a=n(2362),i=n(2601);class s{static getDefaultConfig(){let e="https://demo-project.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.demo";return e&&t?{url:e,anonKey:t,serviceRoleKey:i.env.SUPABASE_SERVICE_ROLE_KEY,connectionPool:10,timeout:30}:null}static async loadConfigFromDatabase(){try{let e=this.getDefaultConfig();if(!e)return console.warn("No default config available, cannot load from database"),null;let t=(0,a.eI)(e.url,e.anonKey),{data:n,error:i}=await t.from("settings").select("key, value").in("key",["db_url","db_anon_key","db_service_key","db_connection_pool","db_timeout"]);if(i)return console.warn("Failed to load config from database:",i),e;if(!n||0===n.length)return console.log("No database config found, using default"),e;let s={};n.forEach(e=>{switch(e.key){case"db_url":s.url=e.value;break;case"db_anon_key":s.anonKey=e.value;break;case"db_service_key":s.serviceRoleKey=e.value;break;case"db_connection_pool":s.connectionPool=parseInt(e.value)||10;break;case"db_timeout":s.timeout=parseInt(e.value)||30}});let l={url:s.url||e.url,anonKey:s.anonKey||e.anonKey,serviceRoleKey:s.serviceRoleKey||e.serviceRoleKey,connectionPool:s.connectionPool||10,timeout:s.timeout||30};return console.log("Loaded config from database successfully"),l}catch(e){return console.error("Error loading config from database:",e),this.getDefaultConfig()}}static async initialize(){if(this.instance.initialized&&this.instance.client)return this.instance.client;try{let e=await this.loadConfigFromDatabase();if(e||(e=this.getDefaultConfig()),!e)return console.error("No valid Supabase configuration found"),null;let t=(0,a.eI)(e.url,e.anonKey,{auth:{persistSession:!0,autoRefreshToken:!0},db:{schema:"public"}});return this.instance.config=e,this.instance.client=t,this.instance.initialized=!0,console.log("Supabase client initialized successfully"),t}catch(e){return console.error("Failed to initialize Supabase client:",e),null}}static getClient(){return this.instance.client}static getConfig(){return this.instance.config}static async reloadConfig(){return this.instance.initialized=!1,this.instance.client=null,this.instance.config=null,await this.initialize()}static async updateConfig(e){try{let t=this.getClient();if(!t)throw Error("No client available for config update");let n=[];for(let a of(e.url&&n.push({key:"db_url",value:e.url,category:"database",is_public:!1}),e.anonKey&&n.push({key:"db_anon_key",value:e.anonKey,category:"database",is_public:!1}),e.serviceRoleKey&&n.push({key:"db_service_key",value:e.serviceRoleKey,category:"database",is_public:!1}),void 0!==e.connectionPool&&n.push({key:"db_connection_pool",value:e.connectionPool.toString(),category:"database",is_public:!1}),void 0!==e.timeout&&n.push({key:"db_timeout",value:e.timeout.toString(),category:"database",is_public:!1}),n)){let{error:e}=await t.from("settings").upsert(a,{onConflict:"key"});if(e)throw e}return await this.reloadConfig(),console.log("Database config updated successfully"),!0}catch(e){return console.error("Failed to update database config:",e),!1}}static async checkConnection(){try{let e=this.getClient();if(!e)return{connected:!1,error:"No client available"};let{data:t,error:n}=await e.from("settings").select("count").limit(1);if(n)return{connected:!1,error:n.message};return{connected:!0}}catch(e){return{connected:!1,error:e.message}}}}s.instance={config:null,client:null,initialized:!1},t.Z=s},2899:function(e,t,n){"use strict";n.d(t,{JU:function(){return s}});var a=n(2362),i=n(7521);function s(){let e=i.Z.getClient();if(e)return e;let t="https://demo-project.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.demo";t&&n||(console.warn("Missing Supabase environment variables, using placeholder values for build"),t||console.error("Missing NEXT_PUBLIC_SUPABASE_URL environment variable"),n||console.error("Missing NEXT_PUBLIC_SUPABASE_ANON_KEY environment variable"));let s=(0,a.eI)(t||"https://placeholder.supabase.co",n||"placeholder-key",{auth:{persistSession:!0,autoRefreshToken:!0},db:{schema:"public"}});return s}s()},7267:function(e,t,n){"use strict";n.d(t,{j:function(){return s}});var a=n(4660),i=n(4810);let s=(0,a.Ue)()((0,i.tJ)((e,t)=>({items:[],addItem:n=>{let a=t().items,i=a.find(e=>e.id===n.id);i?e({items:a.map(e=>e.id===n.id?{...e,quantity:Math.min(e.quantity+1,n.stock_quantity)}:e)}):e({items:[...a,{...n,quantity:1}]})},removeItem:n=>{e({items:t().items.filter(e=>e.id!==n)})},updateQuantity:(n,a)=>{if(a<=0){t().removeItem(n);return}e({items:t().items.map(e=>e.id===n?{...e,quantity:Math.min(a,e.stock_quantity)}:e)})},clearCart:()=>{e({items:[]})},getTotalPrice:()=>t().items.reduce((e,t)=>e+t.price*t.quantity,0),getTotalItems:()=>t().items.reduce((e,t)=>e+t.quantity,0)}),{name:"cart-storage"}))},1396:function(e,t,n){e.exports=n(8326)},4033:function(e,t,n){e.exports=n(94)}},function(e){e.O(0,[199,326,367,971,472,744],function(){return e(e.s=5804)}),_N_E=e.O()}]);